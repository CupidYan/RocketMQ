<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MQClientAPIImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rocketmq-client 4.1.0-incubating-SNAPSHOT</a> &gt; <a href="index.source.html" class="el_package">org.apache.rocketmq.client.impl</a> &gt; <span class="el_source">MQClientAPIImpl.java</span></div><h1>MQClientAPIImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.rocketmq.client.impl;

import java.io.UnsupportedEncodingException;
import java.nio.ByteBuffer;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Set;
import java.util.concurrent.atomic.AtomicInteger;
import org.apache.rocketmq.client.ClientConfig;
import org.apache.rocketmq.client.consumer.PullCallback;
import org.apache.rocketmq.client.consumer.PullResult;
import org.apache.rocketmq.client.consumer.PullStatus;
import org.apache.rocketmq.client.exception.MQBrokerException;
import org.apache.rocketmq.client.exception.MQClientException;
import org.apache.rocketmq.client.hook.SendMessageContext;
import org.apache.rocketmq.client.impl.consumer.PullResultExt;
import org.apache.rocketmq.client.impl.factory.MQClientInstance;
import org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl;
import org.apache.rocketmq.client.impl.producer.TopicPublishInfo;
import org.apache.rocketmq.client.log.ClientLogger;
import org.apache.rocketmq.client.producer.SendCallback;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.client.producer.SendStatus;
import org.apache.rocketmq.common.MQVersion;
import org.apache.rocketmq.common.MixAll;
import org.apache.rocketmq.common.TopicConfig;
import org.apache.rocketmq.common.UtilAll;
import org.apache.rocketmq.common.admin.ConsumeStats;
import org.apache.rocketmq.common.admin.TopicStatsTable;
import org.apache.rocketmq.common.message.Message;
import org.apache.rocketmq.common.message.MessageClientIDSetter;
import org.apache.rocketmq.common.message.MessageConst;
import org.apache.rocketmq.common.message.MessageDecoder;
import org.apache.rocketmq.common.message.MessageExt;
import org.apache.rocketmq.common.message.MessageQueue;
import org.apache.rocketmq.common.namesrv.TopAddressing;
import org.apache.rocketmq.common.protocol.RequestCode;
import org.apache.rocketmq.common.protocol.ResponseCode;
import org.apache.rocketmq.common.protocol.body.BrokerStatsData;
import org.apache.rocketmq.common.protocol.body.ClusterInfo;
import org.apache.rocketmq.common.protocol.body.ConsumeMessageDirectlyResult;
import org.apache.rocketmq.common.protocol.body.ConsumeStatsList;
import org.apache.rocketmq.common.protocol.body.ConsumerConnection;
import org.apache.rocketmq.common.protocol.body.ConsumerRunningInfo;
import org.apache.rocketmq.common.protocol.body.GetConsumerStatusBody;
import org.apache.rocketmq.common.protocol.body.GroupList;
import org.apache.rocketmq.common.protocol.body.KVTable;
import org.apache.rocketmq.common.protocol.body.LockBatchRequestBody;
import org.apache.rocketmq.common.protocol.body.LockBatchResponseBody;
import org.apache.rocketmq.common.protocol.body.ProducerConnection;
import org.apache.rocketmq.common.protocol.body.QueryConsumeTimeSpanBody;
import org.apache.rocketmq.common.protocol.body.QueryCorrectionOffsetBody;
import org.apache.rocketmq.common.protocol.body.QueueTimeSpan;
import org.apache.rocketmq.common.protocol.body.ResetOffsetBody;
import org.apache.rocketmq.common.protocol.body.SubscriptionGroupWrapper;
import org.apache.rocketmq.common.protocol.body.TopicConfigSerializeWrapper;
import org.apache.rocketmq.common.protocol.body.TopicList;
import org.apache.rocketmq.common.protocol.body.UnlockBatchRequestBody;
import org.apache.rocketmq.common.protocol.header.CloneGroupOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.ConsumeMessageDirectlyResultRequestHeader;
import org.apache.rocketmq.common.protocol.header.ConsumerSendMsgBackRequestHeader;
import org.apache.rocketmq.common.protocol.header.CreateTopicRequestHeader;
import org.apache.rocketmq.common.protocol.header.DeleteSubscriptionGroupRequestHeader;
import org.apache.rocketmq.common.protocol.header.DeleteTopicRequestHeader;
import org.apache.rocketmq.common.protocol.header.EndTransactionRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumeStatsInBrokerHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumeStatsRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerConnectionListRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerListByGroupRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerListByGroupResponseBody;
import org.apache.rocketmq.common.protocol.header.GetConsumerRunningInfoRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerStatusRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetEarliestMsgStoretimeRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetEarliestMsgStoretimeResponseHeader;
import org.apache.rocketmq.common.protocol.header.GetMaxOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetMaxOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.GetMinOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetMinOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.GetProducerConnectionListRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetTopicStatsInfoRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetTopicsByClusterRequestHeader;
import org.apache.rocketmq.common.protocol.header.PullMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.PullMessageResponseHeader;
import org.apache.rocketmq.common.protocol.header.QueryConsumeTimeSpanRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryConsumerOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryConsumerOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.QueryCorrectionOffsetHeader;
import org.apache.rocketmq.common.protocol.header.QueryMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryTopicConsumeByWhoRequestHeader;
import org.apache.rocketmq.common.protocol.header.ResetOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.SearchOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.SearchOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.SendMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.SendMessageRequestHeaderV2;
import org.apache.rocketmq.common.protocol.header.SendMessageResponseHeader;
import org.apache.rocketmq.common.protocol.header.UnregisterClientRequestHeader;
import org.apache.rocketmq.common.protocol.header.UpdateConsumerOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.ViewBrokerStatsDataRequestHeader;
import org.apache.rocketmq.common.protocol.header.ViewMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.filtersrv.RegisterMessageFilterClassRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.DeleteKVConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetKVConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetKVConfigResponseHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetKVListByNamespaceRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetRouteInfoRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.PutKVConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.WipeWritePermOfBrokerRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.WipeWritePermOfBrokerResponseHeader;
import org.apache.rocketmq.common.protocol.heartbeat.HeartbeatData;
import org.apache.rocketmq.common.protocol.route.TopicRouteData;
import org.apache.rocketmq.common.subscription.SubscriptionGroupConfig;
import org.apache.rocketmq.remoting.InvokeCallback;
import org.apache.rocketmq.remoting.RPCHook;
import org.apache.rocketmq.remoting.RemotingClient;
import org.apache.rocketmq.remoting.exception.RemotingCommandException;
import org.apache.rocketmq.remoting.exception.RemotingConnectException;
import org.apache.rocketmq.remoting.exception.RemotingException;
import org.apache.rocketmq.remoting.exception.RemotingSendRequestException;
import org.apache.rocketmq.remoting.exception.RemotingTimeoutException;
import org.apache.rocketmq.remoting.exception.RemotingTooMuchRequestException;
import org.apache.rocketmq.remoting.netty.NettyClientConfig;
import org.apache.rocketmq.remoting.netty.NettyRemotingClient;
import org.apache.rocketmq.remoting.netty.ResponseFuture;
import org.apache.rocketmq.remoting.protocol.LanguageCode;
import org.apache.rocketmq.remoting.protocol.RemotingCommand;
import org.apache.rocketmq.remoting.protocol.RemotingSerializable;
import org.slf4j.Logger;

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">public class MQClientAPIImpl {</span>

<span class="fc" id="L152">    private final static Logger log = ClientLogger.getLog();</span>
<span class="fc" id="L153">    public static boolean sendSmartMsg =</span>
<span class="fc" id="L154">        Boolean.parseBoolean(System.getProperty(&quot;org.apache.rocketmq.client.sendSmartMsg&quot;, &quot;true&quot;));</span>

    static {
<span class="fc" id="L157">        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span>
<span class="fc" id="L158">    }</span>

    private final RemotingClient remotingClient;
    private final TopAddressing topAddressing;
    private final ClientRemotingProcessor clientRemotingProcessor;
<span class="fc" id="L163">    private String nameSrvAddr = null;</span>
    private ClientConfig clientConfig;

    public MQClientAPIImpl(final NettyClientConfig nettyClientConfig, final ClientRemotingProcessor clientRemotingProcessor,
<span class="fc" id="L167">        RPCHook rpcHook, final ClientConfig clientConfig) {</span>
<span class="fc" id="L168">        this.clientConfig = clientConfig;</span>
<span class="fc" id="L169">        topAddressing = new TopAddressing(MixAll.WS_ADDR, clientConfig.getUnitName());</span>
<span class="fc" id="L170">        this.remotingClient = new NettyRemotingClient(nettyClientConfig, null);</span>
<span class="fc" id="L171">        this.clientRemotingProcessor = clientRemotingProcessor;</span>

<span class="fc" id="L173">        this.remotingClient.registerRPCHook(rpcHook);</span>
<span class="fc" id="L174">        this.remotingClient.registerProcessor(RequestCode.CHECK_TRANSACTION_STATE, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L176">        this.remotingClient.registerProcessor(RequestCode.NOTIFY_CONSUMER_IDS_CHANGED, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L178">        this.remotingClient.registerProcessor(RequestCode.RESET_CONSUMER_CLIENT_OFFSET, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L180">        this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_STATUS_FROM_CLIENT, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L182">        this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_RUNNING_INFO, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L184">        this.remotingClient.registerProcessor(RequestCode.CONSUME_MESSAGE_DIRECTLY, this.clientRemotingProcessor, null);</span>
<span class="fc" id="L185">    }</span>

    public List&lt;String&gt; getNameServerAddressList() {
<span class="nc" id="L188">        return this.remotingClient.getNameServerAddressList();</span>
    }

    public RemotingClient getRemotingClient() {
<span class="nc" id="L192">        return remotingClient;</span>
    }

    public String fetchNameServerAddr() {
        try {
<span class="nc" id="L197">            String addrs = this.topAddressing.fetchNSAddr();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (addrs != null) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (!addrs.equals(this.nameSrvAddr)) {</span>
<span class="nc" id="L200">                    log.info(&quot;name server address changed, old=&quot; + this.nameSrvAddr + &quot;, new=&quot; + addrs);</span>
<span class="nc" id="L201">                    this.updateNameServerAddressList(addrs);</span>
<span class="nc" id="L202">                    this.nameSrvAddr = addrs;</span>
<span class="nc" id="L203">                    return nameSrvAddr;</span>
                }
            }
<span class="nc" id="L206">        } catch (Exception e) {</span>
<span class="nc" id="L207">            log.error(&quot;fetchNameServerAddr Exception&quot;, e);</span>
<span class="nc" id="L208">        }</span>
<span class="nc" id="L209">        return nameSrvAddr;</span>
    }

    public void updateNameServerAddressList(final String addrs) {
<span class="fc" id="L213">        List&lt;String&gt; lst = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L214">        String[] addrArray = addrs.split(&quot;;&quot;);</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">        for (String addr : addrArray) {</span>
<span class="fc" id="L216">            lst.add(addr);</span>
        }

<span class="fc" id="L219">        this.remotingClient.updateNameServerAddressList(lst);</span>
<span class="fc" id="L220">    }</span>

    public void start() {
<span class="fc" id="L223">        this.remotingClient.start();</span>
<span class="fc" id="L224">    }</span>

    public void shutdown() {
<span class="fc" id="L227">        this.remotingClient.shutdown();</span>
<span class="fc" id="L228">    }</span>

    public void createSubscriptionGroup(final String addr, final SubscriptionGroupConfig config, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
<span class="nc" id="L232">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_AND_CREATE_SUBSCRIPTIONGROUP, null);</span>

<span class="nc" id="L234">        byte[] body = RemotingSerializable.encode(config);</span>
<span class="nc" id="L235">        request.setBody(body);</span>

<span class="nc" id="L237">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L239" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L242">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L248">        throw new MQClientException(response.getCode(), response.getRemark());</span>

    }

    public void createTopic(final String addr, final String defaultTopic, final TopicConfig topicConfig, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
<span class="nc" id="L254">        CreateTopicRequestHeader requestHeader = new CreateTopicRequestHeader();</span>
<span class="nc" id="L255">        requestHeader.setTopic(topicConfig.getTopicName());</span>
<span class="nc" id="L256">        requestHeader.setDefaultTopic(defaultTopic);</span>
<span class="nc" id="L257">        requestHeader.setReadQueueNums(topicConfig.getReadQueueNums());</span>
<span class="nc" id="L258">        requestHeader.setWriteQueueNums(topicConfig.getWriteQueueNums());</span>
<span class="nc" id="L259">        requestHeader.setPerm(topicConfig.getPerm());</span>
<span class="nc" id="L260">        requestHeader.setTopicFilterType(topicConfig.getTopicFilterType().name());</span>
<span class="nc" id="L261">        requestHeader.setTopicSysFlag(topicConfig.getTopicSysFlag());</span>
<span class="nc" id="L262">        requestHeader.setOrder(topicConfig.isOrder());</span>

<span class="nc" id="L264">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_AND_CREATE_TOPIC, requestHeader);</span>

<span class="nc" id="L266">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L268" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L271">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L277">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public SendResult sendMessage(//
        final String addr, // 1
        final String brokerName, // 2
        final Message msg, // 3
        final SendMessageRequestHeader requestHeader, // 4
        final long timeoutMillis, // 5
        final CommunicationMode communicationMode, // 6
        final SendMessageContext context, // 7
        final DefaultMQProducerImpl producer // 8
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L290">        return sendMessage(addr, brokerName, msg, requestHeader, timeoutMillis, communicationMode, null, null, null, 0, context, producer);</span>
    }

    public SendResult sendMessage(//
        final String addr, // 1
        final String brokerName, // 2
        final Message msg, // 3
        final SendMessageRequestHeader requestHeader, // 4
        final long timeoutMillis, // 5
        final CommunicationMode communicationMode, // 6
        final SendCallback sendCallback, // 7
        final TopicPublishInfo topicPublishInfo, // 8
        final MQClientInstance instance, // 9
        final int retryTimesWhenSendFailed, // 10
        final SendMessageContext context, // 11
        final DefaultMQProducerImpl producer // 12
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L307">        RemotingCommand request = null;</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">        if (sendSmartMsg) {</span>
<span class="fc" id="L309">            SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);</span>
<span class="fc" id="L310">            request = RemotingCommand.createRequestCommand(RequestCode.SEND_MESSAGE_V2, requestHeaderV2);</span>
<span class="fc" id="L311">        } else {</span>
<span class="nc" id="L312">            request = RemotingCommand.createRequestCommand(RequestCode.SEND_MESSAGE, requestHeader);</span>
        }

<span class="fc" id="L315">        request.setBody(msg.getBody());</span>

<span class="pc bpc" id="L317" title="1 of 4 branches missed.">        switch (communicationMode) {</span>
            case ONEWAY:
<span class="fc" id="L319">                this.remotingClient.invokeOneway(addr, request, timeoutMillis);</span>
<span class="fc" id="L320">                return null;</span>
            case ASYNC:
<span class="fc" id="L322">                final AtomicInteger times = new AtomicInteger();</span>
<span class="fc" id="L323">                this.sendMessageAsync(addr, brokerName, msg, timeoutMillis, request, sendCallback, topicPublishInfo, instance,</span>
                    retryTimesWhenSendFailed, times, context, producer);
<span class="fc" id="L325">                return null;</span>
            case SYNC:
<span class="fc" id="L327">                return this.sendMessageSync(addr, brokerName, msg, timeoutMillis, request);</span>
            default:
<span class="nc bnc" id="L329" title="All 2 branches missed.">                assert false;</span>
                break;
        }

<span class="nc" id="L333">        return null;</span>
    }

    private SendResult sendMessageSync(//
        final String addr, //
        final String brokerName, //
        final Message msg, //
        final long timeoutMillis, //
        final RemotingCommand request//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L343">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="pc bpc" id="L344" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="fc" id="L345">        return this.processSendResponse(brokerName, msg, response);</span>
    }

    private void sendMessageAsync(//
        final String addr, //
        final String brokerName, //
        final Message msg, //
        final long timeoutMillis, //
        final RemotingCommand request, //
        final SendCallback sendCallback, //
        final TopicPublishInfo topicPublishInfo, //
        final MQClientInstance instance, //
        final int retryTimesWhenSendFailed, //
        final AtomicInteger times, //
        final SendMessageContext context, //
        final DefaultMQProducerImpl producer //
    ) throws InterruptedException, RemotingException {
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">        this.remotingClient.invokeAsync(addr, request, timeoutMillis, new InvokeCallback() {</span>
            @Override
            public void operationComplete(ResponseFuture responseFuture) {
<span class="fc" id="L365">                RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="pc bpc" id="L366" title="3 of 4 branches missed.">                if (null == sendCallback &amp;&amp; response != null) {</span>

                    try {
<span class="nc" id="L369">                        SendResult sendResult = MQClientAPIImpl.this.processSendResponse(brokerName, msg, response);</span>
<span class="nc bnc" id="L370" title="All 4 branches missed.">                        if (context != null &amp;&amp; sendResult != null) {</span>
<span class="nc" id="L371">                            context.setSendResult(sendResult);</span>
<span class="nc" id="L372">                            context.getProducer().executeSendMessageHookAfter(context);</span>
                        }
<span class="nc" id="L374">                    } catch (Throwable e) {</span>
                        //
<span class="nc" id="L376">                    }</span>

<span class="nc" id="L378">                    producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), false);</span>
<span class="nc" id="L379">                    return;</span>
                }

<span class="pc bpc" id="L382" title="1 of 2 branches missed.">                if (response != null) {</span>
                    try {
<span class="fc" id="L384">                        SendResult sendResult = MQClientAPIImpl.this.processSendResponse(brokerName, msg, response);</span>
<span class="pc bpc" id="L385" title="2 of 4 branches missed.">                        assert sendResult != null;</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">                        if (context != null) {</span>
<span class="fc" id="L387">                            context.setSendResult(sendResult);</span>
<span class="fc" id="L388">                            context.getProducer().executeSendMessageHookAfter(context);</span>
                        }

                        try {
<span class="fc" id="L392">                            sendCallback.onSuccess(sendResult);</span>
<span class="nc" id="L393">                        } catch (Throwable e) {</span>
<span class="fc" id="L394">                        }</span>

<span class="fc" id="L396">                        producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), false);</span>
<span class="nc" id="L397">                    } catch (Exception e) {</span>
<span class="nc" id="L398">                        producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), true);</span>
<span class="nc" id="L399">                        onExceptionImpl(brokerName, msg, 0L, request, sendCallback, topicPublishInfo, instance,</span>
                            retryTimesWhenSendFailed, times, e, context, false, producer);
<span class="pc" id="L401">                    }</span>
                } else {
<span class="nc" id="L403">                    producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), true);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                    if (!responseFuture.isSendRequestOK()) {</span>
<span class="nc" id="L405">                        MQClientException ex = new MQClientException(&quot;send request failed&quot;, responseFuture.getCause());</span>
<span class="nc" id="L406">                        onExceptionImpl(brokerName, msg, 0L, request, sendCallback, topicPublishInfo, instance,</span>
                            retryTimesWhenSendFailed, times, ex, context, true, producer);
<span class="nc bnc" id="L408" title="All 2 branches missed.">                    } else if (responseFuture.isTimeout()) {</span>
<span class="nc" id="L409">                        MQClientException ex = new MQClientException(&quot;wait response timeout &quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot;,</span>
<span class="nc" id="L410">                            responseFuture.getCause());</span>
<span class="nc" id="L411">                        onExceptionImpl(brokerName, msg, 0L, request, sendCallback, topicPublishInfo, instance,</span>
                            retryTimesWhenSendFailed, times, ex, context, true, producer);
<span class="nc" id="L413">                    } else {</span>
<span class="nc" id="L414">                        MQClientException ex = new MQClientException(&quot;unknow reseaon&quot;, responseFuture.getCause());</span>
<span class="nc" id="L415">                        onExceptionImpl(brokerName, msg, 0L, request, sendCallback, topicPublishInfo, instance,</span>
                            retryTimesWhenSendFailed, times, ex, context, true, producer);
                    }
                }
<span class="fc" id="L419">            }</span>
        });
<span class="fc" id="L421">    }</span>

    private void onExceptionImpl(final String brokerName, //
        final Message msg, //
        final long timeoutMillis, //
        final RemotingCommand request, //
        final SendCallback sendCallback, //
        final TopicPublishInfo topicPublishInfo, //
        final MQClientInstance instance, //
        final int timesTotal, //
        final AtomicInteger curTimes, //
        final Exception e, //
        final SendMessageContext context, //
        final boolean needRetry, //
        final DefaultMQProducerImpl producer // 12
    ) {
<span class="nc" id="L437">        int tmp = curTimes.incrementAndGet();</span>
<span class="nc bnc" id="L438" title="All 4 branches missed.">        if (needRetry &amp;&amp; tmp &lt;= timesTotal) {</span>
<span class="nc" id="L439">            MessageQueue tmpmq = producer.selectOneMessageQueue(topicPublishInfo, brokerName);</span>
<span class="nc" id="L440">            String addr = instance.findBrokerAddressInPublish(tmpmq.getBrokerName());</span>
<span class="nc" id="L441">            log.info(&quot;async send msg by retry {} times. topic={}, brokerAddr={}, brokerName={}&quot;, tmp, msg.getTopic(), addr,</span>
<span class="nc" id="L442">                tmpmq.getBrokerName());</span>
            try {
<span class="nc" id="L444">                request.setOpaque(RemotingCommand.createNewRequestId());</span>
<span class="nc" id="L445">                sendMessageAsync(addr, tmpmq.getBrokerName(), msg, timeoutMillis, request, sendCallback, topicPublishInfo, instance,</span>
                    timesTotal, curTimes, context, producer);
<span class="nc" id="L447">            } catch (InterruptedException e1) {</span>
<span class="nc" id="L448">                onExceptionImpl(tmpmq.getBrokerName(), msg, timeoutMillis, request, sendCallback, topicPublishInfo, instance, timesTotal, curTimes, e1,</span>
                    context, false, producer);
<span class="nc" id="L450">            } catch (RemotingConnectException e1) {</span>
<span class="nc" id="L451">                producer.updateFaultItem(brokerName, 3000, true);</span>
<span class="nc" id="L452">                onExceptionImpl(tmpmq.getBrokerName(), msg, timeoutMillis, request, sendCallback, topicPublishInfo, instance, timesTotal, curTimes, e1,</span>
                    context, true, producer);
<span class="nc" id="L454">            } catch (RemotingTooMuchRequestException e1) {</span>
<span class="nc" id="L455">                onExceptionImpl(tmpmq.getBrokerName(), msg, timeoutMillis, request, sendCallback, topicPublishInfo, instance, timesTotal, curTimes, e1,</span>
                    context, false, producer);
<span class="nc" id="L457">            } catch (RemotingException e1) {</span>
<span class="nc" id="L458">                producer.updateFaultItem(brokerName, 3000, true);</span>
<span class="nc" id="L459">                onExceptionImpl(tmpmq.getBrokerName(), msg, timeoutMillis, request, sendCallback, topicPublishInfo, instance, timesTotal, curTimes, e1,</span>
                    context, true, producer);
<span class="nc" id="L461">            }</span>
<span class="nc" id="L462">        } else {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">            if (context != null) {</span>
<span class="nc" id="L464">                context.setException(e);</span>
<span class="nc" id="L465">                context.getProducer().executeSendMessageHookAfter(context);</span>
            }
            try {
<span class="nc" id="L468">                sendCallback.onException(e);</span>
<span class="nc" id="L469">            } catch (Exception ignored) {</span>
<span class="nc" id="L470">            }</span>
        }
<span class="nc" id="L472">    }</span>

    private SendResult processSendResponse(//
        final String brokerName, //
        final Message msg, //
        final RemotingCommand response//
    ) throws MQBrokerException, RemotingCommandException {
<span class="fc bfc" id="L479" title="All 2 branches covered.">        switch (response.getCode()) {</span>
            case ResponseCode.FLUSH_DISK_TIMEOUT:
            case ResponseCode.FLUSH_SLAVE_TIMEOUT:
            case ResponseCode.SLAVE_NOT_AVAILABLE: {
                // TODO LOG
            }
            case ResponseCode.SUCCESS: {
<span class="fc" id="L486">                SendStatus sendStatus = SendStatus.SEND_OK;</span>
<span class="pc bpc" id="L487" title="4 of 5 branches missed.">                switch (response.getCode()) {</span>
                    case ResponseCode.FLUSH_DISK_TIMEOUT:
<span class="nc" id="L489">                        sendStatus = SendStatus.FLUSH_DISK_TIMEOUT;</span>
<span class="nc" id="L490">                        break;</span>
                    case ResponseCode.FLUSH_SLAVE_TIMEOUT:
<span class="nc" id="L492">                        sendStatus = SendStatus.FLUSH_SLAVE_TIMEOUT;</span>
<span class="nc" id="L493">                        break;</span>
                    case ResponseCode.SLAVE_NOT_AVAILABLE:
<span class="nc" id="L495">                        sendStatus = SendStatus.SLAVE_NOT_AVAILABLE;</span>
<span class="nc" id="L496">                        break;</span>
                    case ResponseCode.SUCCESS:
<span class="fc" id="L498">                        sendStatus = SendStatus.SEND_OK;</span>
<span class="fc" id="L499">                        break;</span>
                    default:
<span class="nc bnc" id="L501" title="All 2 branches missed.">                        assert false;</span>
                        break;
                }

<span class="fc" id="L505">                SendMessageResponseHeader responseHeader =</span>
<span class="fc" id="L506">                    (SendMessageResponseHeader) response.decodeCommandCustomHeader(SendMessageResponseHeader.class);</span>

<span class="fc" id="L508">                MessageQueue messageQueue = new MessageQueue(msg.getTopic(), brokerName, responseHeader.getQueueId());</span>

<span class="fc" id="L510">                SendResult sendResult = new SendResult(sendStatus,</span>
<span class="fc" id="L511">                    MessageClientIDSetter.getUniqID(msg),</span>
<span class="fc" id="L512">                    responseHeader.getMsgId(), messageQueue, responseHeader.getQueueOffset());</span>
<span class="fc" id="L513">                sendResult.setTransactionId(responseHeader.getTransactionId());</span>
<span class="fc" id="L514">                String regionId = response.getExtFields().get(MessageConst.PROPERTY_MSG_REGION);</span>
<span class="fc" id="L515">                String traceOn = response.getExtFields().get(MessageConst.PROPERTY_TRACE_SWITCH);</span>
<span class="pc bpc" id="L516" title="2 of 4 branches missed.">                if (regionId == null || regionId.isEmpty()) {</span>
<span class="nc" id="L517">                    regionId = MixAll.DEFAULT_TRACE_REGION_ID;</span>
                }
<span class="pc bpc" id="L519" title="2 of 4 branches missed.">                if (traceOn != null &amp;&amp; traceOn.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L520">                    sendResult.setTraceOn(false);</span>
                } else {
<span class="fc" id="L522">                    sendResult.setTraceOn(true);</span>
                }
<span class="fc" id="L524">                sendResult.setRegionId(regionId);</span>
<span class="fc" id="L525">                return sendResult;</span>
            }
            default:
                break;
        }

<span class="fc" id="L531">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public PullResult pullMessage(//
        final String addr, //
        final PullMessageRequestHeader requestHeader, //
        final long timeoutMillis, //
        final CommunicationMode communicationMode, //
        final PullCallback pullCallback//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L541">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.PULL_MESSAGE, requestHeader);</span>

<span class="nc bnc" id="L543" title="All 4 branches missed.">        switch (communicationMode) {</span>
            case ONEWAY:
<span class="nc bnc" id="L545" title="All 2 branches missed.">                assert false;</span>
<span class="nc" id="L546">                return null;</span>
            case ASYNC:
<span class="nc" id="L548">                this.pullMessageAsync(addr, request, timeoutMillis, pullCallback);</span>
<span class="nc" id="L549">                return null;</span>
            case SYNC:
<span class="nc" id="L551">                return this.pullMessageSync(addr, request, timeoutMillis);</span>
            default:
<span class="nc bnc" id="L553" title="All 2 branches missed.">                assert false;</span>
                break;
        }

<span class="nc" id="L557">        return null;</span>
    }

    private void pullMessageAsync(//
        final String addr, // 1
        final RemotingCommand request, //
        final long timeoutMillis, //
        final PullCallback pullCallback//
    ) throws RemotingException, InterruptedException {
<span class="nc bnc" id="L566" title="All 2 branches missed.">        this.remotingClient.invokeAsync(addr, request, timeoutMillis, new InvokeCallback() {</span>
            @Override
            public void operationComplete(ResponseFuture responseFuture) {
<span class="nc" id="L569">                RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                if (response != null) {</span>
                    try {
<span class="nc" id="L572">                        PullResult pullResult = MQClientAPIImpl.this.processPullResponse(response);</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">                        assert pullResult != null;</span>
<span class="nc" id="L574">                        pullCallback.onSuccess(pullResult);</span>
<span class="nc" id="L575">                    } catch (Exception e) {</span>
<span class="nc" id="L576">                        pullCallback.onException(e);</span>
<span class="nc" id="L577">                    }</span>
                } else {
<span class="nc bnc" id="L579" title="All 2 branches missed.">                    if (!responseFuture.isSendRequestOK()) {</span>
<span class="nc" id="L580">                        pullCallback.onException(new MQClientException(&quot;send request failed&quot;, responseFuture.getCause()));</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                    } else if (responseFuture.isTimeout()) {</span>
<span class="nc" id="L582">                        pullCallback.onException(new MQClientException(&quot;wait response timeout &quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot;,</span>
<span class="nc" id="L583">                            responseFuture.getCause()));</span>
                    } else {
<span class="nc" id="L585">                        pullCallback.onException(new MQClientException(&quot;unknow reseaon&quot;, responseFuture.getCause()));</span>
                    }
                }
<span class="nc" id="L588">            }</span>
        });
<span class="nc" id="L590">    }</span>

    private PullResult pullMessageSync(//
        final String addr, // 1
        final RemotingCommand request, // 2
        final long timeoutMillis// 3
    ) throws RemotingException, InterruptedException, MQBrokerException {
<span class="nc" id="L597">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L598" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc" id="L599">        return this.processPullResponse(response);</span>
    }

    private PullResult processPullResponse(final RemotingCommand response) throws MQBrokerException, RemotingCommandException {
<span class="nc" id="L603">        PullStatus pullStatus = PullStatus.NO_NEW_MSG;</span>
<span class="nc bnc" id="L604" title="All 5 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS:
<span class="nc" id="L606">                pullStatus = PullStatus.FOUND;</span>
<span class="nc" id="L607">                break;</span>
            case ResponseCode.PULL_NOT_FOUND:
<span class="nc" id="L609">                pullStatus = PullStatus.NO_NEW_MSG;</span>
<span class="nc" id="L610">                break;</span>
            case ResponseCode.PULL_RETRY_IMMEDIATELY:
<span class="nc" id="L612">                pullStatus = PullStatus.NO_MATCHED_MSG;</span>
<span class="nc" id="L613">                break;</span>
            case ResponseCode.PULL_OFFSET_MOVED:
<span class="nc" id="L615">                pullStatus = PullStatus.OFFSET_ILLEGAL;</span>
<span class="nc" id="L616">                break;</span>

            default:
<span class="nc" id="L619">                throw new MQBrokerException(response.getCode(), response.getRemark());</span>
        }

<span class="nc" id="L622">        PullMessageResponseHeader responseHeader =</span>
<span class="nc" id="L623">            (PullMessageResponseHeader) response.decodeCommandCustomHeader(PullMessageResponseHeader.class);</span>

<span class="nc" id="L625">        return new PullResultExt(pullStatus, responseHeader.getNextBeginOffset(), responseHeader.getMinOffset(),</span>
<span class="nc" id="L626">            responseHeader.getMaxOffset(), null, responseHeader.getSuggestWhichBrokerId(), response.getBody());</span>
    }

    public MessageExt viewMessage(final String addr, final long phyoffset, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L631">        ViewMessageRequestHeader requestHeader = new ViewMessageRequestHeader();</span>
<span class="nc" id="L632">        requestHeader.setOffset(phyoffset);</span>
<span class="nc" id="L633">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.VIEW_MESSAGE_BY_ID, requestHeader);</span>

<span class="nc" id="L635">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L637" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L640">                ByteBuffer byteBuffer = ByteBuffer.wrap(response.getBody());</span>
<span class="nc" id="L641">                MessageExt messageExt = MessageDecoder.clientDecode(byteBuffer, true);</span>
<span class="nc" id="L642">                return messageExt;</span>
            }
            default:
                break;
        }

<span class="nc" id="L648">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public long searchOffset(final String addr, final String topic, final int queueId, final long timestamp, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L653">        SearchOffsetRequestHeader requestHeader = new SearchOffsetRequestHeader();</span>
<span class="nc" id="L654">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L655">        requestHeader.setQueueId(queueId);</span>
<span class="nc" id="L656">        requestHeader.setTimestamp(timestamp);</span>
<span class="nc" id="L657">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.SEARCH_OFFSET_BY_TIMESTAMP, requestHeader);</span>

<span class="nc" id="L659">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L661" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L664">                SearchOffsetResponseHeader responseHeader =</span>
<span class="nc" id="L665">                    (SearchOffsetResponseHeader) response.decodeCommandCustomHeader(SearchOffsetResponseHeader.class);</span>
<span class="nc" id="L666">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L672">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public long getMaxOffset(final String addr, final String topic, final int queueId, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L677">        GetMaxOffsetRequestHeader requestHeader = new GetMaxOffsetRequestHeader();</span>
<span class="nc" id="L678">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L679">        requestHeader.setQueueId(queueId);</span>
<span class="nc" id="L680">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_MAX_OFFSET, requestHeader);</span>

<span class="nc" id="L682">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L684" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L687">                GetMaxOffsetResponseHeader responseHeader =</span>
<span class="nc" id="L688">                    (GetMaxOffsetResponseHeader) response.decodeCommandCustomHeader(GetMaxOffsetResponseHeader.class);</span>

<span class="nc" id="L690">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L696">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public List&lt;String&gt; getConsumerIdListByGroup(//
        final String addr, //
        final String consumerGroup, //
        final long timeoutMillis) throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        MQBrokerException, InterruptedException {
<span class="nc" id="L704">        GetConsumerListByGroupRequestHeader requestHeader = new GetConsumerListByGroupRequestHeader();</span>
<span class="nc" id="L705">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L706">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUMER_LIST_BY_GROUP, requestHeader);</span>

<span class="nc" id="L708">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L710" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="nc" id="L714">                    GetConsumerListByGroupResponseBody body =</span>
<span class="nc" id="L715">                        GetConsumerListByGroupResponseBody.decode(response.getBody(), GetConsumerListByGroupResponseBody.class);</span>
<span class="nc" id="L716">                    return body.getConsumerIdList();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L723">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public long getMinOffset(final String addr, final String topic, final int queueId, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L728">        GetMinOffsetRequestHeader requestHeader = new GetMinOffsetRequestHeader();</span>
<span class="nc" id="L729">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L730">        requestHeader.setQueueId(queueId);</span>
<span class="nc" id="L731">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_MIN_OFFSET, requestHeader);</span>

<span class="nc" id="L733">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L735" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L738">                GetMinOffsetResponseHeader responseHeader =</span>
<span class="nc" id="L739">                    (GetMinOffsetResponseHeader) response.decodeCommandCustomHeader(GetMinOffsetResponseHeader.class);</span>

<span class="nc" id="L741">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L747">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public long getEarliestMsgStoretime(final String addr, final String topic, final int queueId, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L752">        GetEarliestMsgStoretimeRequestHeader requestHeader = new GetEarliestMsgStoretimeRequestHeader();</span>
<span class="nc" id="L753">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L754">        requestHeader.setQueueId(queueId);</span>
<span class="nc" id="L755">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_EARLIEST_MSG_STORETIME, requestHeader);</span>

<span class="nc" id="L757">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L759" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L762">                GetEarliestMsgStoretimeResponseHeader responseHeader =</span>
<span class="nc" id="L763">                    (GetEarliestMsgStoretimeResponseHeader) response.decodeCommandCustomHeader(GetEarliestMsgStoretimeResponseHeader.class);</span>

<span class="nc" id="L765">                return responseHeader.getTimestamp();</span>
            }
            default:
                break;
        }

<span class="nc" id="L771">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public long queryConsumerOffset(//
        final String addr, //
        final QueryConsumerOffsetRequestHeader requestHeader, //
        final long timeoutMillis//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L779">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_CONSUMER_OFFSET, requestHeader);</span>

<span class="nc" id="L781">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L783" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L786">                QueryConsumerOffsetResponseHeader responseHeader =</span>
<span class="nc" id="L787">                    (QueryConsumerOffsetResponseHeader) response.decodeCommandCustomHeader(QueryConsumerOffsetResponseHeader.class);</span>

<span class="nc" id="L789">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L795">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void updateConsumerOffset(//
        final String addr, //
        final UpdateConsumerOffsetRequestHeader requestHeader, //
        final long timeoutMillis//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L803">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_CONSUMER_OFFSET, requestHeader);</span>

<span class="nc" id="L805">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L807" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L810">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L816">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void updateConsumerOffsetOneway(//
        final String addr, //
        final UpdateConsumerOffsetRequestHeader requestHeader, //
        final long timeoutMillis//
    ) throws RemotingConnectException, RemotingTooMuchRequestException, RemotingTimeoutException, RemotingSendRequestException,
        InterruptedException {
<span class="nc" id="L825">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_CONSUMER_OFFSET, requestHeader);</span>

<span class="nc" id="L827">        this.remotingClient.invokeOneway(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="nc" id="L828">    }</span>

    public void sendHearbeat(//
        final String addr, //
        final HeartbeatData heartbeatData, //
        final long timeoutMillis//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L835">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.HEART_BEAT, null);</span>

<span class="nc" id="L837">        request.setBody(heartbeatData.encode());</span>
<span class="nc" id="L838">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L839" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L842">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L848">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void unregisterClient(//
        final String addr, //
        final String clientID, //
        final String producerGroup, //
        final String consumerGroup, //
        final long timeoutMillis//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L858">        final UnregisterClientRequestHeader requestHeader = new UnregisterClientRequestHeader();</span>
<span class="nc" id="L859">        requestHeader.setClientID(clientID);</span>
<span class="nc" id="L860">        requestHeader.setProducerGroup(producerGroup);</span>
<span class="nc" id="L861">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L862">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UNREGISTER_CLIENT, requestHeader);</span>

<span class="nc" id="L864">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L865" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L868">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L874">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void endTransactionOneway(//
        final String addr, //
        final EndTransactionRequestHeader requestHeader, //
        final String remark, //
        final long timeoutMillis//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L883">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.END_TRANSACTION, requestHeader);</span>

<span class="nc" id="L885">        request.setRemark(remark);</span>
<span class="nc" id="L886">        this.remotingClient.invokeOneway(addr, request, timeoutMillis);</span>
<span class="nc" id="L887">    }</span>

    public void queryMessage(
        final String addr,
        final QueryMessageRequestHeader requestHeader,
        final long timeoutMillis,
        final InvokeCallback invokeCallback,
        final Boolean isUnqiueKey
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L896">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_MESSAGE, requestHeader);</span>
<span class="nc" id="L897">        request.addExtField(MixAll.UNIQUE_MSG_QUERY_FLAG, isUnqiueKey.toString());</span>
<span class="nc" id="L898">        this.remotingClient.invokeAsync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis,</span>
            invokeCallback);
<span class="nc" id="L900">    }</span>

    public boolean registerClient(final String addr, final HeartbeatData heartbeat, final long timeoutMillis)
        throws RemotingException, InterruptedException {
<span class="nc" id="L904">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.HEART_BEAT, null);</span>

<span class="nc" id="L906">        request.setBody(heartbeat.encode());</span>
<span class="nc" id="L907">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">        return response.getCode() == ResponseCode.SUCCESS;</span>
    }

    public void consumerSendMessageBack(
        final String addr,
        final MessageExt msg,
        final String consumerGroup,
        final int delayLevel,
        final long timeoutMillis,
        final int maxConsumeRetryTimes
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L919">        ConsumerSendMsgBackRequestHeader requestHeader = new ConsumerSendMsgBackRequestHeader();</span>
<span class="nc" id="L920">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</span>

<span class="nc" id="L922">        requestHeader.setGroup(consumerGroup);</span>
<span class="nc" id="L923">        requestHeader.setOriginTopic(msg.getTopic());</span>
<span class="nc" id="L924">        requestHeader.setOffset(msg.getCommitLogOffset());</span>
<span class="nc" id="L925">        requestHeader.setDelayLevel(delayLevel);</span>
<span class="nc" id="L926">        requestHeader.setOriginMsgId(msg.getMsgId());</span>
<span class="nc" id="L927">        requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</span>

<span class="nc" id="L929">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L931" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L934">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L940">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public Set&lt;MessageQueue&gt; lockBatchMQ(//
        final String addr, //
        final LockBatchRequestBody requestBody, //
        final long timeoutMillis) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L947">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.LOCK_BATCH_MQ, null);</span>

<span class="nc" id="L949">        request.setBody(requestBody.encode());</span>
<span class="nc" id="L950">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L952" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L954">                LockBatchResponseBody responseBody = LockBatchResponseBody.decode(response.getBody(), LockBatchResponseBody.class);</span>
<span class="nc" id="L955">                Set&lt;MessageQueue&gt; messageQueues = responseBody.getLockOKMQSet();</span>
<span class="nc" id="L956">                return messageQueues;</span>
            }
            default:
                break;
        }

<span class="nc" id="L962">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void unlockBatchMQ(//
        final String addr, //
        final UnlockBatchRequestBody requestBody, //
        final long timeoutMillis, //
        final boolean oneway//
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L971">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UNLOCK_BATCH_MQ, null);</span>

<span class="nc" id="L973">        request.setBody(requestBody.encode());</span>

<span class="nc bnc" id="L975" title="All 2 branches missed.">        if (oneway) {</span>
<span class="nc" id="L976">            this.remotingClient.invokeOneway(addr, request, timeoutMillis);</span>
        } else {
<span class="nc" id="L978">            RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L979">                .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">            switch (response.getCode()) {</span>
                case ResponseCode.SUCCESS: {
<span class="nc" id="L982">                    return;</span>
                }
                default:
                    break;
            }

<span class="nc" id="L988">            throw new MQBrokerException(response.getCode(), response.getRemark());</span>
        }
<span class="nc" id="L990">    }</span>

    public TopicStatsTable getTopicStatsInfo(final String addr, final String topic, final long timeoutMillis) throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L994">        GetTopicStatsInfoRequestHeader requestHeader = new GetTopicStatsInfoRequestHeader();</span>
<span class="nc" id="L995">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L997">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_TOPIC_STATS_INFO, requestHeader);</span>

<span class="nc" id="L999">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1001" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1003">                TopicStatsTable topicStatsTable = TopicStatsTable.decode(response.getBody(), TopicStatsTable.class);</span>
<span class="nc" id="L1004">                return topicStatsTable;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1010">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public ConsumeStats getConsumeStats(final String addr, final String consumerGroup, final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException,
        MQBrokerException {
<span class="nc" id="L1016">        return getConsumeStats(addr, consumerGroup, null, timeoutMillis);</span>
    }

    public ConsumeStats getConsumeStats(final String addr, final String consumerGroup, final String topic, final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException,
        MQBrokerException {
<span class="nc" id="L1022">        GetConsumeStatsRequestHeader requestHeader = new GetConsumeStatsRequestHeader();</span>
<span class="nc" id="L1023">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L1024">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L1026">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUME_STATS, requestHeader);</span>

<span class="nc" id="L1028">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1032">                ConsumeStats consumeStats = ConsumeStats.decode(response.getBody(), ConsumeStats.class);</span>
<span class="nc" id="L1033">                return consumeStats;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1039">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public ProducerConnection getProducerConnectionList(final String addr, final String producerGroup, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L1045">        GetProducerConnectionListRequestHeader requestHeader = new GetProducerConnectionListRequestHeader();</span>
<span class="nc" id="L1046">        requestHeader.setProducerGroup(producerGroup);</span>

<span class="nc" id="L1048">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_PRODUCER_CONNECTION_LIST, requestHeader);</span>

<span class="nc" id="L1050">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1052" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1054">                return ProducerConnection.decode(response.getBody(), ProducerConnection.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1060">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public ConsumerConnection getConsumerConnectionList(final String addr, final String consumerGroup, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L1066">        GetConsumerConnectionListRequestHeader requestHeader = new GetConsumerConnectionListRequestHeader();</span>
<span class="nc" id="L1067">        requestHeader.setConsumerGroup(consumerGroup);</span>

<span class="nc" id="L1069">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUMER_CONNECTION_LIST, requestHeader);</span>

<span class="nc" id="L1071">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1073" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1075">                return ConsumerConnection.decode(response.getBody(), ConsumerConnection.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1081">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public KVTable getBrokerRuntimeInfo(final String addr, final long timeoutMillis) throws RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQBrokerException {

<span class="nc" id="L1087">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_RUNTIME_INFO, null);</span>

<span class="nc" id="L1089">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1091" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1093">                return KVTable.decode(response.getBody(), KVTable.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1099">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void updateBrokerConfig(final String addr, final Properties properties, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException, UnsupportedEncodingException {

<span class="nc" id="L1106">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_BROKER_CONFIG, null);</span>

<span class="nc" id="L1108">        String str = MixAll.properties2String(properties);</span>
<span class="nc bnc" id="L1109" title="All 4 branches missed.">        if (str != null &amp;&amp; str.length() &gt; 0) {</span>
<span class="nc" id="L1110">            request.setBody(str.getBytes(MixAll.DEFAULT_CHARSET));</span>
<span class="nc" id="L1111">            RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L1112">                .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">            switch (response.getCode()) {</span>
                case ResponseCode.SUCCESS: {
<span class="nc" id="L1115">                    return;</span>
                }
                default:
                    break;
            }

<span class="nc" id="L1121">            throw new MQBrokerException(response.getCode(), response.getRemark());</span>
        }
<span class="nc" id="L1123">    }</span>

    public Properties getBrokerConfig(final String addr, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException, UnsupportedEncodingException {
<span class="nc" id="L1128">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CONFIG, null);</span>

<span class="nc" id="L1130">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1131" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1134">                return MixAll.string2Properties(new String(response.getBody(), MixAll.DEFAULT_CHARSET));</span>
            }
            default:
                break;
        }

<span class="nc" id="L1140">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public ClusterInfo getBrokerClusterInfo(final long timeoutMillis) throws InterruptedException, RemotingTimeoutException,
        RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L1145">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CLUSTER_INFO, null);</span>

<span class="nc" id="L1147">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1148" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1151">                return ClusterInfo.decode(response.getBody(), ClusterInfo.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1157">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public TopicRouteData getDefaultTopicRouteInfoFromNameServer(final String topic, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1162">        GetRouteInfoRequestHeader requestHeader = new GetRouteInfoRequestHeader();</span>
<span class="nc" id="L1163">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L1165">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ROUTEINTO_BY_TOPIC, requestHeader);</span>

<span class="nc" id="L1167">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1168" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1169" title="All 3 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.TOPIC_NOT_EXIST: {
                // TODO LOG
<span class="nc" id="L1172">                break;</span>
            }
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1175">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1177">                    return TopicRouteData.decode(body, TopicRouteData.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1184">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicRouteData getTopicRouteInfoFromNameServer(final String topic, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="fc" id="L1189">        GetRouteInfoRequestHeader requestHeader = new GetRouteInfoRequestHeader();</span>
<span class="fc" id="L1190">        requestHeader.setTopic(topic);</span>

<span class="fc" id="L1192">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ROUTEINTO_BY_TOPIC, requestHeader);</span>

<span class="nc" id="L1194">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1195" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1196" title="All 3 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.TOPIC_NOT_EXIST: {
<span class="nc bnc" id="L1198" title="All 2 branches missed.">                if (!topic.equals(MixAll.DEFAULT_TOPIC))</span>
<span class="nc" id="L1199">                    log.warn(&quot;get Topic [{}] RouteInfoFromNameServer is not exist value&quot;, topic);</span>
                break;
            }
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1203">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1205">                    return TopicRouteData.decode(body, TopicRouteData.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1212">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getTopicListFromNameServer(final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1217">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER, null);</span>

<span class="nc" id="L1219">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1220" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1223">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1224" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1225">                    return TopicList.decode(body, TopicList.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1232">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public int wipeWritePermOfBroker(final String namesrvAddr, String brokerName, final long timeoutMillis) throws RemotingCommandException,
        RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQClientException {
<span class="nc" id="L1237">        WipeWritePermOfBrokerRequestHeader requestHeader = new WipeWritePermOfBrokerRequestHeader();</span>
<span class="nc" id="L1238">        requestHeader.setBrokerName(brokerName);</span>

<span class="nc" id="L1240">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.WIPE_WRITE_PERM_OF_BROKER, requestHeader);</span>

<span class="nc" id="L1242">        RemotingCommand response = this.remotingClient.invokeSync(namesrvAddr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1243" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1246">                WipeWritePermOfBrokerResponseHeader responseHeader =</span>
<span class="nc" id="L1247">                    (WipeWritePermOfBrokerResponseHeader) response.decodeCommandCustomHeader(WipeWritePermOfBrokerResponseHeader.class);</span>
<span class="nc" id="L1248">                return responseHeader.getWipeTopicCount();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1254">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteTopicInBroker(final String addr, final String topic, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
<span class="nc" id="L1259">        DeleteTopicRequestHeader requestHeader = new DeleteTopicRequestHeader();</span>
<span class="nc" id="L1260">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1261">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_TOPIC_IN_BROKER, requestHeader);</span>

<span class="nc" id="L1263">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1265" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1268">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1274">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteTopicInNameServer(final String addr, final String topic, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
<span class="nc" id="L1279">        DeleteTopicRequestHeader requestHeader = new DeleteTopicRequestHeader();</span>
<span class="nc" id="L1280">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1281">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_TOPIC_IN_NAMESRV, requestHeader);</span>

<span class="nc" id="L1283">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1284" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1287">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1293">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteSubscriptionGroup(final String addr, final String groupName, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
<span class="nc" id="L1298">        DeleteSubscriptionGroupRequestHeader requestHeader = new DeleteSubscriptionGroupRequestHeader();</span>
<span class="nc" id="L1299">        requestHeader.setGroupName(groupName);</span>
<span class="nc" id="L1300">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_SUBSCRIPTIONGROUP, requestHeader);</span>

<span class="nc" id="L1302">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1304" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1307">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1313">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public String getKVConfigValue(final String namespace, final String key, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1318">        GetKVConfigRequestHeader requestHeader = new GetKVConfigRequestHeader();</span>
<span class="nc" id="L1319">        requestHeader.setNamespace(namespace);</span>
<span class="nc" id="L1320">        requestHeader.setKey(key);</span>

<span class="nc" id="L1322">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_KV_CONFIG, requestHeader);</span>

<span class="nc" id="L1324">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1325" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1328">                GetKVConfigResponseHeader responseHeader =</span>
<span class="nc" id="L1329">                    (GetKVConfigResponseHeader) response.decodeCommandCustomHeader(GetKVConfigResponseHeader.class);</span>
<span class="nc" id="L1330">                return responseHeader.getValue();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1336">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void putKVConfigValue(final String namespace, final String key, final String value, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1341">        PutKVConfigRequestHeader requestHeader = new PutKVConfigRequestHeader();</span>
<span class="nc" id="L1342">        requestHeader.setNamespace(namespace);</span>
<span class="nc" id="L1343">        requestHeader.setKey(key);</span>
<span class="nc" id="L1344">        requestHeader.setValue(value);</span>

<span class="nc" id="L1346">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.PUT_KV_CONFIG, requestHeader);</span>

<span class="nc" id="L1348">        List&lt;String&gt; nameServerAddressList = this.remotingClient.getNameServerAddressList();</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">        if (nameServerAddressList != null) {</span>
<span class="nc" id="L1350">            RemotingCommand errResponse = null;</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">            for (String namesrvAddr : nameServerAddressList) {</span>
<span class="nc" id="L1352">                RemotingCommand response = this.remotingClient.invokeSync(namesrvAddr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1353" title="All 4 branches missed.">                assert response != null;</span>
<span class="nc bnc" id="L1354" title="All 2 branches missed.">                switch (response.getCode()) {</span>
                    case ResponseCode.SUCCESS: {
<span class="nc" id="L1356">                        break;</span>
                    }
                    default:
<span class="nc" id="L1359">                        errResponse = response;</span>
                }
<span class="nc" id="L1361">            }</span>

<span class="nc bnc" id="L1363" title="All 2 branches missed.">            if (errResponse != null) {</span>
<span class="nc" id="L1364">                throw new MQClientException(errResponse.getCode(), errResponse.getRemark());</span>
            }
        }
<span class="nc" id="L1367">    }</span>

    public void deleteKVConfigValue(final String namespace, final String key, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1371">        DeleteKVConfigRequestHeader requestHeader = new DeleteKVConfigRequestHeader();</span>
<span class="nc" id="L1372">        requestHeader.setNamespace(namespace);</span>
<span class="nc" id="L1373">        requestHeader.setKey(key);</span>

<span class="nc" id="L1375">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_KV_CONFIG, requestHeader);</span>

<span class="nc" id="L1377">        List&lt;String&gt; nameServerAddressList = this.remotingClient.getNameServerAddressList();</span>
<span class="nc bnc" id="L1378" title="All 2 branches missed.">        if (nameServerAddressList != null) {</span>
<span class="nc" id="L1379">            RemotingCommand errResponse = null;</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">            for (String namesrvAddr : nameServerAddressList) {</span>
<span class="nc" id="L1381">                RemotingCommand response = this.remotingClient.invokeSync(namesrvAddr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1382" title="All 4 branches missed.">                assert response != null;</span>
<span class="nc bnc" id="L1383" title="All 2 branches missed.">                switch (response.getCode()) {</span>
                    case ResponseCode.SUCCESS: {
<span class="nc" id="L1385">                        break;</span>
                    }
                    default:
<span class="nc" id="L1388">                        errResponse = response;</span>
                }
<span class="nc" id="L1390">            }</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">            if (errResponse != null) {</span>
<span class="nc" id="L1392">                throw new MQClientException(errResponse.getCode(), errResponse.getRemark());</span>
            }
        }
<span class="nc" id="L1395">    }</span>

    public KVTable getKVListByNamespace(final String namespace, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1399">        GetKVListByNamespaceRequestHeader requestHeader = new GetKVListByNamespaceRequestHeader();</span>
<span class="nc" id="L1400">        requestHeader.setNamespace(namespace);</span>

<span class="nc" id="L1402">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_KVLIST_BY_NAMESPACE, requestHeader);</span>

<span class="nc" id="L1404">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1405" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1408">                return KVTable.decode(response.getBody(), KVTable.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1414">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Map&lt;MessageQueue, Long&gt; invokeBrokerToResetOffset(final String addr, final String topic, final String group,
        final long timestamp, final boolean isForce, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1420">        return invokeBrokerToResetOffset(addr, topic, group, timestamp, isForce, timeoutMillis, false);</span>
    }

    public Map&lt;MessageQueue, Long&gt; invokeBrokerToResetOffset(final String addr, final String topic, final String group,
        final long timestamp, final boolean isForce, final long timeoutMillis, boolean isC)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1426">        ResetOffsetRequestHeader requestHeader = new ResetOffsetRequestHeader();</span>
<span class="nc" id="L1427">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1428">        requestHeader.setGroup(group);</span>
<span class="nc" id="L1429">        requestHeader.setTimestamp(timestamp);</span>
<span class="nc" id="L1430">        requestHeader.setForce(isForce);</span>

<span class="nc" id="L1432">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.INVOKE_BROKER_TO_RESET_OFFSET, requestHeader);</span>
<span class="nc bnc" id="L1433" title="All 2 branches missed.">        if (isC) {</span>
<span class="nc" id="L1434">            request.setLanguage(LanguageCode.CPP);</span>
        }

<span class="nc" id="L1437">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1439" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc bnc" id="L1442" title="All 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="nc" id="L1443">                    ResetOffsetBody body = ResetOffsetBody.decode(response.getBody(), ResetOffsetBody.class);</span>
<span class="nc" id="L1444">                    return body.getOffsetTable();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1451">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Map&lt;String, Map&lt;MessageQueue, Long&gt;&gt; invokeBrokerToGetConsumerStatus(final String addr, final String topic, final String group,
        final String clientAddr, final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1456">        GetConsumerStatusRequestHeader requestHeader = new GetConsumerStatusRequestHeader();</span>
<span class="nc" id="L1457">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1458">        requestHeader.setGroup(group);</span>
<span class="nc" id="L1459">        requestHeader.setClientAddr(clientAddr);</span>

<span class="nc" id="L1461">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.INVOKE_BROKER_TO_GET_CONSUMER_STATUS, requestHeader);</span>

<span class="nc" id="L1463">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1465" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1466" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc bnc" id="L1468" title="All 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="nc" id="L1469">                    GetConsumerStatusBody body = GetConsumerStatusBody.decode(response.getBody(), GetConsumerStatusBody.class);</span>
<span class="nc" id="L1470">                    return body.getConsumerTable();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1477">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public GroupList queryTopicConsumeByWho(final String addr, final String topic, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L1483">        QueryTopicConsumeByWhoRequestHeader requestHeader = new QueryTopicConsumeByWhoRequestHeader();</span>
<span class="nc" id="L1484">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L1486">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_TOPIC_CONSUME_BY_WHO, requestHeader);</span>

<span class="nc" id="L1488">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1490" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1492">                GroupList groupList = GroupList.decode(response.getBody(), GroupList.class);</span>
<span class="nc" id="L1493">                return groupList;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1499">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public List&lt;QueueTimeSpan&gt; queryConsumeTimeSpan(final String addr, final String topic, final String group, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L1505">        QueryConsumeTimeSpanRequestHeader requestHeader = new QueryConsumeTimeSpanRequestHeader();</span>
<span class="nc" id="L1506">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1507">        requestHeader.setGroup(group);</span>

<span class="nc" id="L1509">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_CONSUME_TIME_SPAN, requestHeader);</span>

<span class="nc" id="L1511">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1513" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1515">                QueryConsumeTimeSpanBody consumeTimeSpanBody = GroupList.decode(response.getBody(), QueryConsumeTimeSpanBody.class);</span>
<span class="nc" id="L1516">                return consumeTimeSpanBody.getConsumeTimeSpanSet();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1522">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getTopicsByCluster(final String cluster, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1527">        GetTopicsByClusterRequestHeader requestHeader = new GetTopicsByClusterRequestHeader();</span>
<span class="nc" id="L1528">        requestHeader.setCluster(cluster);</span>
<span class="nc" id="L1529">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_TOPICS_BY_CLUSTER, requestHeader);</span>

<span class="nc" id="L1531">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1532" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1535">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1537">                    TopicList topicList = TopicList.decode(body, TopicList.class);</span>
<span class="nc" id="L1538">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1545">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void registerMessageFilterClass(final String addr, //
        final String consumerGroup, //
        final String topic, //
        final String className, //
        final int classCRC, //
        final byte[] classBody, //
        final long timeoutMillis) throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        InterruptedException, MQBrokerException {
<span class="nc" id="L1556">        RegisterMessageFilterClassRequestHeader requestHeader = new RegisterMessageFilterClassRequestHeader();</span>
<span class="nc" id="L1557">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L1558">        requestHeader.setClassName(className);</span>
<span class="nc" id="L1559">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1560">        requestHeader.setClassCRC(classCRC);</span>

<span class="nc" id="L1562">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.REGISTER_MESSAGE_FILTER_CLASS, requestHeader);</span>
<span class="nc" id="L1563">        request.setBody(classBody);</span>
<span class="nc" id="L1564">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1565" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1567">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1573">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getSystemTopicList(final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1577">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS, null);</span>

<span class="nc" id="L1579">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1580" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1581" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1583">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1585">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L1586" title="All 4 branches missed.">                    if (topicList.getTopicList() != null &amp;&amp; !topicList.getTopicList().isEmpty()</span>
<span class="nc bnc" id="L1587" title="All 2 branches missed.">                        &amp;&amp; !UtilAll.isBlank(topicList.getBrokerAddr())) {</span>
<span class="nc" id="L1588">                        TopicList tmp = getSystemTopicListFromBroker(topicList.getBrokerAddr(), timeoutMillis);</span>
<span class="nc bnc" id="L1589" title="All 4 branches missed.">                        if (tmp.getTopicList() != null &amp;&amp; !tmp.getTopicList().isEmpty()) {</span>
<span class="nc" id="L1590">                            topicList.getTopicList().addAll(tmp.getTopicList());</span>
                        }
                    }
<span class="nc" id="L1593">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1600">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getSystemTopicListFromBroker(final String addr, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1605">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_BROKER, null);</span>

<span class="nc" id="L1607">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1609" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1610" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1612">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1613" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1614">                    TopicList topicList = TopicList.decode(body, TopicList.class);</span>
<span class="nc" id="L1615">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1622">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public boolean cleanExpiredConsumeQueue(final String addr, long timeoutMillis) throws MQClientException, RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
<span class="nc" id="L1627">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CLEAN_EXPIRED_CONSUMEQUEUE, null);</span>
<span class="nc" id="L1628">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1630" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1632">                return true;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1638">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public boolean cleanUnusedTopicByAddr(final String addr, long timeoutMillis) throws MQClientException, RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
<span class="nc" id="L1643">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CLEAN_UNUSED_TOPIC, null);</span>
<span class="nc" id="L1644">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1646" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1648">                return true;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1654">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public ConsumerRunningInfo getConsumerRunningInfo(final String addr, String consumerGroup, String clientId, boolean jstack,
        final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1659">        GetConsumerRunningInfoRequestHeader requestHeader = new GetConsumerRunningInfoRequestHeader();</span>
<span class="nc" id="L1660">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L1661">        requestHeader.setClientId(clientId);</span>
<span class="nc" id="L1662">        requestHeader.setJstackEnable(jstack);</span>

<span class="nc" id="L1664">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUMER_RUNNING_INFO, requestHeader);</span>

<span class="nc" id="L1666">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1668" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1671">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1672" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1673">                    ConsumerRunningInfo info = ConsumerRunningInfo.decode(body, ConsumerRunningInfo.class);</span>
<span class="nc" id="L1674">                    return info;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1681">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public ConsumeMessageDirectlyResult consumeMessageDirectly(final String addr, //
        String consumerGroup, //
        String clientId, //
        String msgId, //
        final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1689">        ConsumeMessageDirectlyResultRequestHeader requestHeader = new ConsumeMessageDirectlyResultRequestHeader();</span>
<span class="nc" id="L1690">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L1691">        requestHeader.setClientId(clientId);</span>
<span class="nc" id="L1692">        requestHeader.setMsgId(msgId);</span>

<span class="nc" id="L1694">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUME_MESSAGE_DIRECTLY, requestHeader);</span>

<span class="nc" id="L1696">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1698" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1699" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1701">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1703">                    ConsumeMessageDirectlyResult info = ConsumeMessageDirectlyResult.decode(body, ConsumeMessageDirectlyResult.class);</span>
<span class="nc" id="L1704">                    return info;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1711">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Map&lt;Integer, Long&gt; queryCorrectionOffset(final String addr, final String topic, final String group, Set&lt;String&gt; filterGroup,
        long timeoutMillis) throws MQClientException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        InterruptedException {
<span class="nc" id="L1717">        QueryCorrectionOffsetHeader requestHeader = new QueryCorrectionOffsetHeader();</span>
<span class="nc" id="L1718">        requestHeader.setCompareGroup(group);</span>
<span class="nc" id="L1719">        requestHeader.setTopic(topic);</span>
<span class="nc bnc" id="L1720" title="All 2 branches missed.">        if (filterGroup != null) {</span>
<span class="nc" id="L1721">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L1722">            String splitor = &quot;&quot;;</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">            for (String s : filterGroup) {</span>
<span class="nc" id="L1724">                sb.append(splitor).append(s);</span>
<span class="nc" id="L1725">                splitor = &quot;,&quot;;</span>
<span class="nc" id="L1726">            }</span>
<span class="nc" id="L1727">            requestHeader.setFilterGroups(sb.toString());</span>
        }
<span class="nc" id="L1729">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_CORRECTION_OFFSET, requestHeader);</span>

<span class="nc" id="L1731">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1733" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1734" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc bnc" id="L1736" title="All 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="nc" id="L1737">                    QueryCorrectionOffsetBody body = QueryCorrectionOffsetBody.decode(response.getBody(), QueryCorrectionOffsetBody.class);</span>
<span class="nc" id="L1738">                    return body.getCorrectionOffsets();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1745">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getUnitTopicList(final boolean containRetry, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1750">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_UNIT_TOPIC_LIST, null);</span>

<span class="nc" id="L1752">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1753" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1754" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1756">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1757" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1758">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L1759" title="All 2 branches missed.">                    if (!containRetry) {</span>
<span class="nc" id="L1760">                        Iterator&lt;String&gt; it = topicList.getTopicList().iterator();</span>
<span class="nc bnc" id="L1761" title="All 2 branches missed.">                        while (it.hasNext()) {</span>
<span class="nc" id="L1762">                            String topic = it.next();</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">                            if (topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX))</span>
<span class="nc" id="L1764">                                it.remove();</span>
<span class="nc" id="L1765">                        }</span>
                    }

<span class="nc" id="L1768">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1775">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getHasUnitSubTopicList(final boolean containRetry, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1780">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST, null);</span>

<span class="nc" id="L1782">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1783" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1784" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1786">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1787" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1788">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L1789" title="All 2 branches missed.">                    if (!containRetry) {</span>
<span class="nc" id="L1790">                        Iterator&lt;String&gt; it = topicList.getTopicList().iterator();</span>
<span class="nc bnc" id="L1791" title="All 2 branches missed.">                        while (it.hasNext()) {</span>
<span class="nc" id="L1792">                            String topic = it.next();</span>
<span class="nc bnc" id="L1793" title="All 2 branches missed.">                            if (topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX))</span>
<span class="nc" id="L1794">                                it.remove();</span>
<span class="nc" id="L1795">                        }</span>
                    }
<span class="nc" id="L1797">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1804">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getHasUnitSubUnUnitTopicList(final boolean containRetry, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1809">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST, null);</span>

<span class="nc" id="L1811">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1812" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1813" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1815">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1816" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1817">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L1818" title="All 2 branches missed.">                    if (!containRetry) {</span>
<span class="nc" id="L1819">                        Iterator&lt;String&gt; it = topicList.getTopicList().iterator();</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">                        while (it.hasNext()) {</span>
<span class="nc" id="L1821">                            String topic = it.next();</span>
<span class="nc bnc" id="L1822" title="All 2 branches missed.">                            if (topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX))</span>
<span class="nc" id="L1823">                                it.remove();</span>
<span class="nc" id="L1824">                        }</span>
                    }
<span class="nc" id="L1826">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1833">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void cloneGroupOffset(final String addr, final String srcGroup, final String destGroup, final String topic,
        final boolean isOffline, final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1838">        CloneGroupOffsetRequestHeader requestHeader = new CloneGroupOffsetRequestHeader();</span>
<span class="nc" id="L1839">        requestHeader.setSrcGroup(srcGroup);</span>
<span class="nc" id="L1840">        requestHeader.setDestGroup(destGroup);</span>
<span class="nc" id="L1841">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1842">        requestHeader.setOffline(isOffline);</span>
<span class="nc" id="L1843">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CLONE_GROUP_OFFSET, requestHeader);</span>

<span class="nc" id="L1845">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1847" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1848" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1850">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1856">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public BrokerStatsData viewBrokerStatsData(String brokerAddr, String statsName, String statsKey, long timeoutMillis)
        throws MQClientException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        InterruptedException {
<span class="nc" id="L1862">        ViewBrokerStatsDataRequestHeader requestHeader = new ViewBrokerStatsDataRequestHeader();</span>
<span class="nc" id="L1863">        requestHeader.setStatsName(statsName);</span>
<span class="nc" id="L1864">        requestHeader.setStatsKey(statsKey);</span>

<span class="nc" id="L1866">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.VIEW_BROKER_STATS_DATA, requestHeader);</span>

<span class="nc" id="L1868">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L1869">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L1870" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1871" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1873">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1874" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1875">                    return BrokerStatsData.decode(body, BrokerStatsData.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1882">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Set&lt;String&gt; getClusterList(String topic, long timeoutMillis) throws MQClientException, RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
        // todo:jodie
<span class="nc" id="L1888">        return Collections.EMPTY_SET;</span>
    }

    public ConsumeStatsList fetchConsumeStatsInBroker(String brokerAddr, boolean isOrder, long timeoutMillis) throws MQClientException,
        RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
<span class="nc" id="L1893">        GetConsumeStatsInBrokerHeader requestHeader = new GetConsumeStatsInBrokerHeader();</span>
<span class="nc" id="L1894">        requestHeader.setIsOrder(isOrder);</span>

<span class="nc" id="L1896">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CONSUME_STATS, requestHeader);</span>

<span class="nc" id="L1898">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L1899">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L1900" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1903">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1904" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1905">                    return ConsumeStatsList.decode(body, ConsumeStatsList.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1912">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public SubscriptionGroupWrapper getAllSubscriptionGroup(final String brokerAddr, long timeoutMillis) throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L1917">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_SUBSCRIPTIONGROUP_CONFIG, null);</span>
<span class="nc" id="L1918">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L1919">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L1920" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1921" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1923">                return SubscriptionGroupWrapper.decode(response.getBody(), SubscriptionGroupWrapper.class);</span>
            }
            default:
                break;
        }
<span class="nc" id="L1928">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public TopicConfigSerializeWrapper getAllTopicConfig(final String addr, long timeoutMillis) throws RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQBrokerException {
<span class="nc" id="L1933">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_TOPIC_CONFIG, null);</span>

<span class="nc" id="L1935">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1937" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1938" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1940">                return TopicConfigSerializeWrapper.decode(response.getBody(), TopicConfigSerializeWrapper.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1946">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void updateNameServerConfig(final Properties properties, final List&lt;String&gt; nameServers, long timeoutMillis)
        throws UnsupportedEncodingException,
        MQBrokerException, InterruptedException, RemotingTimeoutException, RemotingSendRequestException,
        RemotingConnectException, MQClientException {
<span class="nc" id="L1953">        String str = MixAll.properties2String(properties);</span>
<span class="nc bnc" id="L1954" title="All 4 branches missed.">        if (str == null || str.length() &lt; 1) {</span>
<span class="nc" id="L1955">            return;</span>
        }
<span class="nc bnc" id="L1957" title="All 4 branches missed.">        List&lt;String&gt; invokeNameServers = (nameServers == null || nameServers.isEmpty()) ?</span>
<span class="nc" id="L1958">            this.remotingClient.getNameServerAddressList() : nameServers;</span>
<span class="nc bnc" id="L1959" title="All 4 branches missed.">        if (invokeNameServers == null || invokeNameServers.isEmpty()) {</span>
<span class="nc" id="L1960">            return;</span>
        }

<span class="nc" id="L1963">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_NAMESRV_CONFIG, null);</span>
<span class="nc" id="L1964">        request.setBody(str.getBytes(MixAll.DEFAULT_CHARSET));</span>

<span class="nc" id="L1966">        RemotingCommand errResponse = null;</span>
<span class="nc bnc" id="L1967" title="All 2 branches missed.">        for (String nameServer : invokeNameServers) {</span>
<span class="nc" id="L1968">            RemotingCommand response = this.remotingClient.invokeSync(nameServer, request, timeoutMillis);</span>
<span class="nc bnc" id="L1969" title="All 4 branches missed.">            assert response != null;</span>
<span class="nc bnc" id="L1970" title="All 2 branches missed.">            switch (response.getCode()) {</span>
                case ResponseCode.SUCCESS: {
<span class="nc" id="L1972">                    break;</span>
                }
                default:
<span class="nc" id="L1975">                    errResponse = response;</span>
            }
<span class="nc" id="L1977">        }</span>

<span class="nc bnc" id="L1979" title="All 2 branches missed.">        if (errResponse != null) {</span>
<span class="nc" id="L1980">            throw new MQClientException(errResponse.getCode(), errResponse.getRemark());</span>
        }
<span class="nc" id="L1982">    }</span>

    public Map&lt;String, Properties&gt; getNameServerConfig(final List&lt;String&gt; nameServers, long timeoutMillis)
        throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException,
        MQClientException, UnsupportedEncodingException {
<span class="nc bnc" id="L1988" title="All 4 branches missed.">        List&lt;String&gt; invokeNameServers = (nameServers == null || nameServers.isEmpty()) ?</span>
<span class="nc" id="L1989">            this.remotingClient.getNameServerAddressList() : nameServers;</span>
<span class="nc bnc" id="L1990" title="All 4 branches missed.">        if (invokeNameServers == null || invokeNameServers.isEmpty()) {</span>
<span class="nc" id="L1991">            return null;</span>
        }

<span class="nc" id="L1994">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_NAMESRV_CONFIG, null);</span>

<span class="nc" id="L1996">        Map&lt;String, Properties&gt; configMap = new HashMap&lt;String, Properties&gt;(4);</span>
<span class="nc bnc" id="L1997" title="All 2 branches missed.">        for (String nameServer : invokeNameServers) {</span>
<span class="nc" id="L1998">            RemotingCommand response = this.remotingClient.invokeSync(nameServer, request, timeoutMillis);</span>

<span class="nc bnc" id="L2000" title="All 4 branches missed.">            assert response != null;</span>

<span class="nc bnc" id="L2002" title="All 2 branches missed.">            if (ResponseCode.SUCCESS == response.getCode()) {</span>
<span class="nc" id="L2003">                configMap.put(nameServer, MixAll.string2Properties(new String(response.getBody(), MixAll.DEFAULT_CHARSET)));</span>
            } else {
<span class="nc" id="L2005">                throw new MQClientException(response.getCode(), response.getRemark());</span>
            }
<span class="nc" id="L2007">        }</span>
<span class="nc" id="L2008">        return configMap;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>